<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Pro Media Viewer</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
<style>
/* --- Global & Base Styling --- */
body {
    font-family: 'Roboto', Arial, sans-serif;
    background: #121212; /* Darker, modern background */
    color: #E0E0E0; /* Light text for contrast */
    padding: 30px;
}
header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 15px;
    border-bottom: 1px solid #333; /* Subtle separator */
}
h1 {
    margin: 0;
    color: #00AEEF; /* Accent color */
    font-weight: 700;
    letter-spacing: 1px;
}
h3 {
    color: #F5F5F5;
    font-weight: 400;
    margin-top: 25px;
    margin-bottom: 10px;
}
hr {
    border: none;
    border-top: 1px solid #333;
    margin: 30px 0;
}

/* --- Admin Link Button --- */
a.admin-link {
    padding: 8px 16px;
    background: #00AEEF; /* Blue Accent */
    color: #fff;
    text-decoration: none;
    border-radius: 20px; /* Pill shape for modern look */
    font-weight: 500;
    transition: background 0.2s ease, transform 0.1s ease;
}
a.admin-link:hover {
    background: #008CC9;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 174, 239, 0.2);
}

/* --- Video Player Area Styling --- */
#videoPlayerContainer {
    margin-top: 20px;
    background: #1E1E1E; /* Slightly lighter dark background for the container */
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5); /* Stronger shadow */
}
#videoPlayerContainer > p {
    color: #AAAAAA;
    text-align: center;
    padding: 40px;
}
.video-container {
    position: relative;
    padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
    height: 0;
    overflow: hidden;
    max-width: 100%;
    border-radius: 4px;
    background: #000;
}
.video-container > * { 
    position: absolute; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
}
.player-message {
    margin-top: 10px;
    color: #AAAAAA;
    font-size: 0.9em;
    padding: 5px 0;
}

/* --- Video List Styling - Major Change --- */
#videoList {
    display: grid;
    /* Create a responsive grid layout */
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
    gap: 15px; /* Spacing between cards */
    padding-top: 5px;
}
.video-card {
    /* The card itself is the container for the title span */
    border-radius: 6px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
    background: #252525;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.video-card:hover {
    transform: translateY(-3px); /* Lift effect on hover */
    box-shadow: 0 6px 12px rgba(0, 174, 239, 0.3); /* Accent glow on hover */
}
.video-title {
    cursor: pointer;
    color: #F5F5F5; 
    text-decoration: none; /* No underline */
    display: block;
    padding: 15px;
    font-size: 1em;
    font-weight: 400;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis; /* ... for long titles */
}
.video-title:hover {
    color: #00AEEF; /* Accent color on hover */
    background: #2E2E2E; /* Slight background change on hover */
}
</style>
</head>
<body>

<header>
Â  <h1>ðŸ“º Pro Media Viewer</h1>
Â  <a href="admin_login.html" class="admin-link">Admin Portal</a>
</header>

<div id="videoPlayerContainer">
    <p>Select a video title from the list below to start playback.</p>
</div>

<hr>

<h3>Video Library</h3>
<div id="videoList">Loading videos...</div>

<script>
// IMPORTANT: Keep this URL for both list loading and the streaming proxy logic.
const WEB_APP_URL="https://script.google.com/macros/s/AKfycbzq22Fzcm_w-IAAiDpqx2TQKkHJjKq7fnlP-5IdtrgwFG7Wo2HaDNFxro7tZKIoMol0/exec";

const videoListDiv = document.getElementById("videoList");
const playerContainer = document.getElementById("videoPlayerContainer");

// --- Helper Functions ---

/**
 * Extracts the Google Drive File ID from a URL.
 */
function getFileId(url) {
    if (!url) return null;
    const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/) || url.match(/id=([a-zA-Z0-9_-]+)/);
    return match ? match[1] : null;
}

/**
 * Generates the robust HTML video player with HTML5 primary and Iframe secondary fallback.
 */
function getPlayableEmbed(originalUrl, directUrl, title) {
    const fileId = getFileId(originalUrl);
    let html = `<h3>Now Playing: ${title}</h3>`;
    let videoSourceUrl = directUrl; 

    if (fileId) {
        // Use the Apps Script proxy URL for Drive files
        videoSourceUrl = `${WEB_APP_URL}?streamFileId=${fileId}`;
    }

    if (!videoSourceUrl) {
        return html + "<p class='player-message'>Error: Could not determine a video source URL.</p>";
    }

    // --- HTML Player Structure ---
    
    // 1. HTML5 Video Attempt (Primary)
    html += `<div class="video-container" id="playerWrapper">
                <video id="gdriveVideo" controls playsinline preload="metadata" style="background:#000;">
                    <source id="videoSource" src="${videoSourceUrl}" type="video/mp4">
                    Your browser does not support the HTML5 Video element.
                </video>
                <iframe id="gdriveIframe" 
                    src="https://drive.google.com/file/d/${fileId}/preview" 
                    frameborder="0" 
                    allow="autoplay; encrypted-media" 
                    style="display:none;" 
                    allowfullscreen>
                </iframe>
            </div>
            <div class="player-message" id="playbackStatus">Attempting secure direct stream...</div>`;
            
    // --- Integration of Event Listeners ---
    
    setTimeout(() => {
        const vid = document.getElementById('gdriveVideo');
        const iframe = document.getElementById('gdriveIframe');
        const status = document.getElementById('playbackStatus');
        
        if (!vid) return;

        function showIframeFallback(reason) {
            console.warn('Using iframe fallback:', reason);
            vid.style.display = 'none';
            iframe.style.display = 'block';
            status.innerHTML = `<span style='color:orange;'>Playback failed (${reason}). Switched to Google Drive viewer.</span>`;
        }
        
        let metadataTimeout = setTimeout(() => {
            showIframeFallback('Stream access blocked or timed out');
        }, 8000); 

        vid.addEventListener('loadedmetadata', () => {
            clearTimeout(metadataTimeout);
            status.innerHTML = 'Video loaded successfully. Use player controls.';
            vid.play().catch(err => {
                status.innerHTML = 'Video loaded, but **Autoplay was blocked** by your browser. Click play on the controls.';
            });
        });

        vid.addEventListener('error', (e) => {
            clearTimeout(metadataTimeout);
            const code = e && e.target && e.target.error ? e.target.error.code : 'unknown';
            if (code === 4 || code === 3) { 
                showIframeFallback(`Codec/Network error (Code ${code}).`);
            } else {
                showIframeFallback(`Video error (Code ${code}).`);
            }
        });

        playerContainer.addEventListener('DOMNodeRemoved', () => {
            clearTimeout(metadataTimeout);
        });

    }, 0); 

    return html;
}

// --- Dynamic List Loading Logic (Unchanged but included for completeness) ---

/**
 * Function executed when a video title is clicked to load the player.
 */
function playVideo(originalUrl, directUrl, title) {
    playerContainer.innerHTML = getPlayableEmbed(originalUrl, directUrl, title);
    // Scroll to the player to ensure it's in view on mobile/smaller screens
    playerContainer.scrollIntoView({ behavior: 'smooth' }); 
}

/**
 * Attaches a 'click' event listener to every video title span.
 */
function setupClickHandlers() {
    // Select all elements with the specific class within the container
    const videoTitles = videoListDiv.querySelectorAll('.video-title');
    
    videoTitles.forEach(span => {
        span.addEventListener('click', function() {
            const title = this.getAttribute('data-title');
            const originalUrl = this.getAttribute('data-original');
            const directUrl = this.getAttribute('data-direct');
            
            playVideo(originalUrl, directUrl, title);
        });
    });
}

// Load videos list via JSONP
function loadVideos(){
Â  const cb="cb"+new Date().getTime();
Â  window[cb]=function(data){
Â  Â  if(!data || data.length === 0){
Â  Â  Â  videoListDiv.innerHTML="<p style='color:#777;text-align:center;'>No videos uploaded yet. Check back soon!</p>";
Â  Â  Â  return;
Â  Â  }
Â  Â  let html="";
Â  Â  data.forEach(v=>{
      const originalUrl = v.original_url || v.url || ""; 
      const directUrl = v.direct_url || "";
      const title = v.title || "Untitled Video";

      // Ensure data attributes are properly encoded
Â  Â  Â  html+=`<div class="video-card">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="video-title" 
                      data-title="${title.replace(/"/g, '&quot;')}"
                      data-original="${originalUrl.replace(/"/g, '&quot;')}" 
                      data-direct="${directUrl.replace(/"/g, '&quot;')}" 
                  >
Â  Â  Â  Â  Â  Â  Â  Â  Â  ${title}
Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  });
Â  Â  
Â  Â  videoListDiv.innerHTML=html;
    setupClickHandlers(); 
Â  };
Â  
Â  const script=document.createElement("script");
Â  script.src=WEB_APP_URL+"?callback="+cb+"&_="+new Date().getTime();
Â  document.body.appendChild(script);
}

// Initial load of the video list
loadVideos();
</script>
</body>
</html>
