<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Video Viewer</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{margin:0;font-family:Arial,sans-serif;background:#000;color:#fff;}
.container{max-width:980px;margin:20px auto;padding:10px;}
.playlist{background:rgba(255,255,255,0.03);padding:10px;border-radius:10px;margin-bottom:12px;max-height:220px;overflow:auto;border:1px solid rgba(255,255,255,0.04);}
.list-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;cursor:pointer;}
.list-item:hover{background:rgba(255,255,255,0.02);}
.title{font-size:15px;}
.small{font-size:12px;color:#888;}
video{width:100%;max-height:62vh;border-radius:8px;background:#000;display:block;}
.controls{display:flex;gap:8px;align-items:center;margin-top:8px;}
.pill{background:rgba(0,0,0,0.4);padding:6px 10px;border-radius:999px;font-size:13px;color:#ddd;}
.admin-link{position:fixed;right:16px;bottom:16px;background:rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;text-decoration:none;color:#ddd;border:1px solid rgba(255,255,255,0.04);}
.empty{padding:36px;text-align:center;color:#888;border-radius:10px;background:rgba(255,255,255,0.02);}
.active{outline:2px solid rgba(11,121,255,0.2);}
</style>
</head>
<body>
<div class="container">
<div id="playlist" class="playlist"></div>
<div id="playerWrap">
<div id="emptyMsg" class="empty" style="display:none">No video available. Admin can add via <a href="admin.html" style="color:#0b79ff">Admin</a>.</div>
<video id="player" controls playsinline webkit-playsinline></video>
<div class="controls" style="display:none" id="playerInfo">
<div class="pill" id="currentTitle"></div>
<div style="flex:1"></div>
<div class="small" id="currentAdded"></div>
</div>
</div>
</div>
<a class="admin-link" href="admin.html">Admin</a>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzq22Fzcm_w-IAAiDpqx2TQKkHJjKq7fnlP-5IdtrgwFG7Wo2HaDNFxro7tZKIoMol0/exec";
const playlistEl = document.getElementById('playlist');
const player = document.getElementById('player');
const emptyMsg = document.getElementById('emptyMsg');
const playerInfo = document.getElementById('playerInfo');
const currentTitle = document.getElementById('currentTitle');
const currentAdded = document.getElementById('currentAdded');

function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

async function fetchVideos(){
  try{
    const resp = await fetch(WEB_APP_URL);
    const arr = await resp.json();
    return arr.sort((a,b)=> new Date(b.addedAt)-new Date(a.addedAt)); // newest first
  } catch(err){ console.error(err); return []; }
}

function renderPlaylist(arr){
  playlistEl.innerHTML='';
  if(arr.length===0){
    emptyMsg.style.display='block';
    player.style.display='none';
    playerInfo.style.display='none';
    return;
  }
  emptyMsg.style.display='none';
  player.style.display='block';
  arr.forEach(it=>{
    const item = document.createElement('div');
    item.className='list-item';
    item.dataset.id=it.id;
    item.innerHTML=`<div>
                      <div class="title">${escapeHtml(it.title)}</div>
                      <div class="small">${escapeHtml(it.original_url)}</div>
                    </div>
                    <div class="small">${new Date(it.addedAt).toLocaleString()}</div>`;
    item.addEventListener('click', ()=>{ playVideo(it); document.querySelectorAll('.list-item').forEach(e=>e.classList.remove('active')); item.classList.add('active'); item.scrollIntoView({behavior:'smooth',block:'nearest'}); });
    playlistEl.appendChild(item);
  });
  playVideo(arr[0]); // auto play newest
  setTimeout(()=>{ const el = playlistEl.querySelector(`[data-id="${arr[0].id}"]`); if(el){el.classList.add('active');} },80);
}

function playVideo(item){
  player.src=item.direct_url;
  player.load();
  player.play().catch(()=>{});
  playerInfo.style.display='flex';
  currentTitle.textContent=item.title;
  currentAdded.textContent=new Date(item.addedAt).toLocaleString();
  emptyMsg.style.display='none';
}

/* initialize */
(async function(){
  const videos = await fetchVideos();
  renderPlaylist(videos);
})();
</script>
</body>
</html>
